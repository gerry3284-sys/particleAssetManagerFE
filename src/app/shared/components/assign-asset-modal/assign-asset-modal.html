<!-- Modal Backdrop -->
@if (isOpen()) {
  <div class="modal-backdrop" (click)="onBackdropClick($event)">
    
    <!-- Modal Container -->
    <div class="modal-container">
      
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="header-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 16V12M12 8h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h2 class="modal-title">Assegna asset</h2>
      </div>

      <!-- Modal Body -->
      <form class="modal-body" (ngSubmit)="onAssign()">
        
        <!-- Data di assegnazione -->
        <div class="form-group">
          <label class="form-label" for="assignmentDate">
            Data di assegnazione <span class="required">*</span>
          </label>
          <input
            type="date"
            id="assignmentDate"
            class="form-control"
            [value]="formData().assignmentDate"
            (change)="updateField('assignmentDate', $any($event.target).value)"
            required />
        </div>

        <!-- Seleziona utente -->
        <div class="form-group">
          <label class="form-label" for="userSelect">
            Seleziona l'utente a cui assegnare l'asset <span class="required">*</span>
          </label>
          
          <div class="custom-select-wrapper">
            <input
              type="text"
              id="userSelect"
              class="form-control custom-select"
              placeholder="Inizia a scrivere..."
              [value]="userSearchQuery()"
              (input)="onUserInputChange($any($event.target).value)"
              (focus)="openUserDropdown()"
              (click)="openUserDropdown()"
              (blur)="closeUserDropdown()"
              (keydown.escape)="closeUserDropdown()"
              autocomplete="off"
              required />
            
            <svg class="select-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>

            <!-- Dropdown utenti -->
            @if (showUserDropdown()) {
              <div class="dropdown-menu">
                @if (filteredUsers().length > 0) {
                  @for (user of filteredUsers(); track user.id) {
                    <div 
                      class="dropdown-item" 
                      (click)="selectUser(user)">
                      <div class="user-info">
                        <span class="user-name">{{ user.name }}</span>
                        <span class="user-bu">{{ user.businessUnit }}</span>
                      </div>
                    </div>
                  }
                } @else {
                  <div class="dropdown-empty">
                    Nessun utente trovato
                  </div>
                }
              </div>
            }
          </div>
          
          <p class="form-hint">
            Verranno mostrati solo gli utenti appartenenti alla BU corretta.
            <br>
            In caso contrario, ti mostrer√≤ tutti gli altri disponibili.
          </p>
        </div>

        <!-- Note (opzionale) -->
        <div class="form-group">
          <label class="form-label" for="notes">
            Note (opzionale)
          </label>
          <textarea
            id="notes"
            class="form-control textarea"
            rows="3"
            placeholder="Es. rimossa SSD, ecc..."
            [value]="formData().notes || ''"
            (input)="updateField('notes', $any($event.target).value)">
          </textarea>
        </div>

      </form>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-cancel"
          (click)="onCancel()">
          Annulla
        </button>
        <button 
          type="button" 
          class="btn btn-assign"
          [disabled]="!isFormValid()"
          (click)="onAssign()">
          Assegna
        </button>
      </div>

    </div>
  </div>
}