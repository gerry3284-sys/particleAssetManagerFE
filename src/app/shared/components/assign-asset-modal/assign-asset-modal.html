@if (isOpen()) {
  <div class="modal-overlay" (click)="onOverlayClick()">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon">i</div>
        <div>
          <h3>Assegna asset</h3>
        </div>
      </div>

      <div class="modal-body">
        <div class="field">
          <label>Data di assegnazione</label>
          <div class="input-with-icon" [class.error]="dateError()">
            <input
              #dateInput
              type="date"
              [value]="assignmentDate()"
              (input)="onDateChange(dateInput.value)"
              required
            />
             <span class="input-icon" aria-hidden="true">
               <svg viewBox="0 0 24 24" fill="none">
                <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.8" />
                <path d="M16 3v4M8 3v4M3 9h18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
              </svg>
            </span>  
          </div>
          @if (dateError()) {
            <p class="error-text">Seleziona una data valida.</p>
          }
        </div>

        <div class="field">
          <label>Seleziona l'utente a cui assegnare l'asset</label>
          <div class="dropdown" [class.error]="userError()">
            <input
              #searchInput
              type="text"
              placeholder="Inizia a scrivere..."
              [value]="searchTerm()"
              (input)="onSearchChange(searchInput.value)"
              (focus)="onInputFocus()"
              (blur)="onInputBlur()"
              required
            />
            <span class="dropdown-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </span>
            @if (dropdownOpen()) {
              <div class="dropdown-panel">
                @for (user of filteredUsers(); track user.id) {
                  <button type="button" (mousedown)="onUserSelect(user)">
                    <span>{{ user.name }}</span>
                    @if (user.businessUnit) {
                      <small>{{ user.businessUnit }}</small>
                    }
                  </button>
                }
                @if (filteredUsers().length === 0) {
                  <div class="dropdown-empty">Nessun risultato</div>
                }
              </div>
            }
          </div>
          <p class="helper-text">
            TUTTI gli utenti indipendentemente da BU. mostrare alert se bu diversa
          </p>
          @if (userError()) {
            <p class="error-text">Seleziona un utente dalla lista.</p>
          }
        </div>

        <div class="field">
          <label>Note (Opzionale)</label>
          <textarea
            #notesInput
            rows="3"
            placeholder="Es. rimossa SSD, ecc..."
            [value]="notes()"
            (input)="notes.set(notesInput.value)"
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="close.emit()">Annulla</button>
        <button class="btn btn-primary" type="button" (click)="submit()">Assegna</button>
      </div>
    </div>
  </div>
}
